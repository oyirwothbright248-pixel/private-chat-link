<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrightTech Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617; --panel: #0f172a; --accent: #0ea5e9; --neon: #38bdf8;
            --text: #f8fafc; --bubble-me: #0284c7; --bubble-them: #334155; --danger: #ef4444;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 20px; border: 1px solid var(--accent); width: 100%; max-width: 400px; text-align: center; }
        
        /* Layout */
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1e293b; flex-shrink: 0; z-index: 100; }
        
        /* Video Grid */
        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #000; max-height: 0; transition: 0.4s; overflow: hidden; flex-shrink: 0; }
        #video-grid.active { max-height: 25vh; padding: 10px; }
        video { width: 100%; border-radius: 8px; background: #1e293b; border: 1px solid var(--accent); }

        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: radial-gradient(circle at top right, #0f172a, #020617); }
        
        /* Contact Drawer */
        #contact-drawer { position: fixed; left: 0; top: 0; bottom: 0; width: 300px; background: var(--panel); transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1500; border-right: 1px solid var(--accent); display: flex; flex-direction: column; }
        #contact-drawer.open { transform: translateX(0); }
        .drawer-header { padding: 20px; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between; align-items: center; }
        #contacts-render { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* Contact Item & Badge */
        .contact-item { padding: 12px; margin-bottom: 8px; background: #1e293b; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; position: relative; }
        .contact-item:hover { background: #334155; }
        .contact-avatar { width: 35px; height: 35px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .badge { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 800; display: none; }
        .badge.active { display: block; }

        /* Bubbles */
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.4; position: relative; }
        .me { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 2px; }
        .them { align-self: flex-start; background: var(--bubble-them); border-bottom-left-radius: 2px; }
        .call-log { font-style: italic; opacity: 0.8; font-size: 12px; align-self: center; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 20px; border: 1px solid #334155; margin: 5px 0; }

        /* Input */
        .input-box { background: var(--panel); padding: 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #1e293b; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        input[type="text"] { flex: 1; background: #020617; border: 1px solid #334155; padding: 12px 20px; border-radius: 25px; color: white; outline: none; }
        .btn-circle { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .btn-send { background: var(--accent); color: white; }
        .btn-voice { background: #1e293b; color: var(--neon); }
        .btn-voice.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .overlay-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1400; }
        #contact-drawer.open + .overlay-bg { display: block; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h2 style="color:var(--neon); margin-bottom: 5px;">BRIGHT TECH</h2>
        <p style="margin-bottom: 20px; opacity: 0.8;">Secure Communication Portal</p>
        
        <input type="email" id="auth-email" placeholder="Email Address" style="width:100%; margin-bottom:10px; padding:12px; border-radius:10px; border:1px solid #334155; background:#020617; color:white;">
        <input type="password" id="auth-password" placeholder="Password" style="width:100%; margin-bottom:15px; padding:12px; border-radius:10px; border:1px solid #334155; background:#020617; color:white;">
        
        <button onclick="secureLogin()" style="width:100%; padding:14px; border-radius:10px; background:var(--accent); border:none; color:white; font-weight:800; cursor:pointer; margin-bottom:10px;">SIGN IN</button>
        <button onclick="secureSignUp()" style="width:100%; padding:14px; border-radius:10px; background:transparent; border:1px solid var(--accent); color:var(--accent); font-weight:800; cursor:pointer;">CREATE ACCOUNT</button>
    </div>
</div>

<div id="contact-drawer">
    <div class="drawer-header">
        <h3 style="margin:0">Contacts</h3>
        <button onclick="toggleDrawer()" style="background:none; border:none; color:white; font-size:20px;">‚úï</button>
    </div>
    <div id="contacts-render"></div>
    <div style="padding: 20px; border-top: 1px solid #1e293b;">
        <button onclick="clearHistory()" style="width:100%; color:var(--danger); background:rgba(239, 68, 68, 0.1); border:1px solid var(--danger); padding:10px; border-radius:8px; cursor:pointer;">üóëÔ∏è Wipe Chat History</button>
        <button onclick="logout()" style="width:100%; color:white; background:none; border:none; margin-top:10px; opacity:0.5; font-size:12px; cursor:pointer;">Logout Session</button>
    </div>
</div>
<div class="overlay-bg" onclick="toggleDrawer()"></div>

<header>
    <button onclick="toggleDrawer()" style="background:none; border:none; font-size:24px; color:white; cursor:pointer;">‚ò∞</button>
    <div id="header-id" style="font-weight:600; font-size:14px; color:var(--neon);">Connecting...</div>
    <div style="display:flex; gap:12px;">
        <button onclick="initiateCall(false)" style="background:none; border:none; font-size:20px; cursor:pointer;">üìû</button>
        <button onclick="initiateCall(true)" style="background:none; border:none; font-size:20px; cursor:pointer;">üìπ</button>
        <button id="hangupBtn" onclick="endCall()" style="display:none; background:var(--danger); border:none; border-radius:50%; width:30px; height:30px; color:white; cursor:pointer;">‚úï</button>
    </div>
</header>

<div id="video-grid">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
</div>

<div id="chat-container"></div>

<div class="input-box">
    <label class="btn-circle" style="background:#1e293b; color:var(--neon);">
        üìé<input type="file" id="file-input" style="display:none" onchange="handleFileUpload(this)">
    </label>
    <input type="text" id="msgInput" placeholder="Write a message...">
    <button id="voiceBtn" class="btn-circle btn-voice">üé§</button>
    <button class="btn-circle btn-send" onclick="send()">‚ûî</button>
</div>

<script>
    const socket = io();
    
    // 1. INITIALIZE SUPABASE WITH AUTH HEADERS
    const supabaseUrl = 'https://bcdnzmnmaxopmsimdetn.supabase.co';
    const supabaseKey = 'sb_publishable_C8ygL8VNGGJ2L2qqTP6g2g_hPYokDmy';
    
    // We initialize without headers first, then update them after login
    let supabase = libSupabase.createClient(supabaseUrl, supabaseKey);

    let myId = null;
    let targetId = window.location.pathname.split('/').pop();
    if(targetId === '' || targetId === 'room') targetId = null;

    let mediaRecorder, audioChunks = [];
    let localStream, peerConnection;
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    const notifications = {};

    // --- INITIALIZATION (SECURE) ---
    window.onload = async () => {
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
            myId = session.user.id;
            
            // Re-initialize with secure headers for RLS
            supabase = libSupabase.createClient(supabaseUrl, supabaseKey, {
                global: { headers: { 'x-user-id': myId } }
            });

            document.getElementById('auth-screen').style.display = 'none';
            socket.emit('join-session', { myId, targetId });
            document.getElementById('header-id').innerText = targetId ? `Chat: ${targetId}` : `ID: ${myId.substring(0,8)}...`;
        }
    };

    // --- SECURE AUTH FUNCTIONS ---
    async function secureLogin() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) alert("Login Error: " + error.message);
        else location.reload();
    }

    async function secureSignUp() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const { data, error } = await supabase.auth.signUp({ email, password });
        
        if (error) alert("Signup Error: " + error.message);
        else alert("Verification email sent! Check your inbox.");
    }

    async function logout() { 
        await supabase.auth.signOut();
        localStorage.removeItem('bt_userid'); 
        location.href = '/'; 
    }

    // --- MESSAGING & CONTACTS ---
    socket.on('load-history', (history) => {
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';
        history.forEach(m => renderMessage(m, m.sender_id === myId ? 'me' : 'them'));
        updateContactList(history);
    });

    function updateContactList(history) {
        const render = document.getElementById('contacts-render');
        const unique = new Set();
        history.forEach(m => { if(m.sender_id !== myId) unique.add(m.sender_id); });
        
        render.innerHTML = unique.size === 0 ? '<p style="text-align:center; opacity:0.5;">No contacts</p>' : '';
        unique.forEach(contact => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.id = `contact-${contact}`;
            div.onclick = () => location.href = `/room/${contact}`;
            
            const badgeClass = notifications[contact] ? 'badge active' : 'badge';
            div.innerHTML = `
                <div class="contact-avatar">${contact.substring(0,1).toUpperCase()}</div>
                <div style="font-size: 10px;">${contact.substring(0,12)}...</div>
                <div class="${badgeClass}">NEW</div>
            `;
            render.appendChild(div);
        });
    }

    async function uploadToSupabase(blob, name) {
        const fileName = `${Date.now()}_${name}`;
        const { data, error } = await supabase.storage.from('chat-assets').upload(`uploads/${fileName}`, blob);
        if (error) { console.error(error); return null; }
        const { data: { publicUrl } } = supabase.storage.from('chat-assets').getPublicUrl(`uploads/${fileName}`);
        return publicUrl;
    }

    async function send() {
        const input = document.getElementById('msgInput');
        if (!input.value.trim() || !targetId) return;
        const data = { sender: myId, target: targetId, msg: input.value, type: 'text' };
        socket.emit('chat-msg', data);
        renderMessage(data, 'me');
        input.value = '';
    }

    socket.on('render-msg', (data) => { 
        if (data.sender !== myId) {
            if (data.sender === targetId) {
                renderMessage(data, 'them');
            } else {
                notifications[data.sender] = true;
                const badge = document.querySelector(`#contact-${data.sender} .badge`);
                if(badge) badge.classList.add('active');
            }
        }
    });

    function renderMessage(msg, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        const content = msg.message || msg.msg;
        
        if (msg.type === 'call') {
            div.className = 'msg call-log';
            div.textContent = `üìû ${content}`;
        } else if (msg.type === 'voice') {
            div.innerHTML = `<audio controls src="${msg.file_url}" style="width:200px"></audio>`;
        } else if (msg.type === 'file') {
            div.innerHTML = `üìÑ <a href="${msg.file_url}" target="_blank" style="color:white; font-weight:800;">View File</a>`;
        } else {
            div.textContent = content;
        }
        document.getElementById('chat-container').appendChild(div);
        document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
    }

    // --- CALLING LOGIC ---
    async function initiateCall(video) {
        if(!targetId) return alert("Select a contact");
        socket.emit('call-request', { sender: myId, target: targetId, video });
        startRTC(video);
    }

    socket.on('incoming-call', (data) => {
        if (confirm(`Incoming call from ${data.sender}. Answer?`)) startRTC(data.video);
    });

    async function startRTC(videoEnabled) {
        if(videoEnabled) document.getElementById('video-grid').classList.add('active');
        document.getElementById('hangupBtn').style.display = 'block';
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoEnabled });
        document.getElementById('localVideo').srcObject = localStream;
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = e => {
            document.getElementById('remoteVideo').srcObject = e.streams[0];
            document.getElementById('video-grid').classList.add('active');
        };
        peerConnection.onicecandidate = e => {
            if(e.candidate) socket.emit('signal', { sender: myId, target: targetId, data: { candidate: e.candidate } });
        };
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('signal', { sender: myId, target: targetId, data: { offer } });
    }

    socket.on('signal', async (data) => {
        if (!peerConnection) return;
        if (data.offer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('signal', { sender: myId, target: targetId, data: { answer } });
        } else if (data.answer) await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        else if (data.candidate) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    });

    function endCall() { location.reload(); }

    // --- VOICE & FILE STORAGE ---
    const voiceBtn = document.getElementById('voiceBtn');
    voiceBtn.onmousedown = startVoice; voiceBtn.onmouseup = stopVoice;
    voiceBtn.ontouchstart = (e) => { e.preventDefault(); startVoice(); };
    voiceBtn.ontouchend = (e) => { e.preventDefault(); stopVoice(); };

    async function startVoice() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        voiceBtn.classList.add('recording');
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    }

    async function stopVoice() {
        if (!mediaRecorder || mediaRecorder.state === "inactive") return;
        mediaRecorder.stop();
        voiceBtn.classList.remove('recording');
        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const url = await uploadToSupabase(blob, 'voice.webm');
            if(url) {
                const data = { sender: myId, target: targetId, type: 'voice', msg: 'Voice Note', file_url: url };
                socket.emit('chat-msg', data);
                renderMessage(data, 'me');
            }
        };
    }

    async function handleFileUpload(input) {
        if(input.files[0]) {
            const url = await uploadToSupabase(input.files[0], input.files[0].name);
            if(url) {
                const data = { sender: myId, target: targetId, type: 'file', msg: `File: ${input.files[0].name}`, file_url: url };
                socket.emit('chat-msg', data);
                renderMessage(data, 'me');
            }
        }
    }

    function toggleDrawer() { document.getElementById('contact-drawer').classList.toggle('open'); }
    function clearHistory() { if(confirm("Wipe chat?")) socket.emit('clear-history', { myId, targetId }); }
</script>