<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrightTech Secure Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617;
            --panel: #0f172a;
            --accent: #0ea5e9;
            --neon: #38bdf8;
            --text: #f8fafc;
            --bubble-me: #0284c7;
            --bubble-them: #334155;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: var(--text);
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; /* Critical for mobile height */
            height: -webkit-fill-available;
            overflow: hidden;
        }

        /* --- STICKY TECH HEADER --- */
        header {
            padding: 12px 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .logo-tech { font-weight: 800; color: var(--neon); font-size: 1.2rem; text-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        
        .copy-btn {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- RESPONSIVE VIDEO GRID --- */
        #video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: #000;
            padding: 0;
            max-height: 0;
            transition: all 0.4s ease-in-out;
            overflow: hidden;
        }

        #video-grid.active { max-height: 30vh; padding: 10px; }

        video { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; background: #1e293b; border: 1px solid #334155; }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: linear-gradient(to bottom, #020617, #0f172a);
        }

        .msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .me { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
        .them { align-self: flex-start; background: var(--bubble-them); border-bottom-left-radius: 4px; }

        /* --- MOBILE RESPONSIVE ACTION BAR --- */
        .action-bar {
            background: var(--panel);
            padding: 10px 20px;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #1e293b;
            flex-shrink: 0;
        }

        .icon-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: var(--text);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: 0.2s;
        }

        .icon-btn:active { transform: scale(0.9); background: var(--accent); }
        .btn-call { color: #22c55e; border-color: #22c55e; }
        .btn-video { color: var(--accent); border-color: var(--accent); }
        .btn-hangup { color: var(--danger); border-color: var(--danger); display: none; }

        /* --- INPUT AREA --- */
        .input-area {
            padding: 12px 15px;
            background: var(--panel);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom); /* iOS support */
        }

        input {
            flex: 1;
            background: #020617;
            border: 1px solid #334155;
            padding: 14px 18px;
            border-radius: 30px;
            color: white;
            font-size: 16px; /* Prevents auto-zoom on iPhone */
            outline: none;
        }

        .send-btn {
            background: var(--accent);
            color: #020617;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-weight: 800;
            cursor: pointer;
        }

        /* Responsive Fixes */
        @media (max-width: 600px) {
            #video-grid.active { grid-template-columns: 1fr; max-height: 45vh; }
            .logo-tech { font-size: 1rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-tech">BRIGHT<span style="color:white">TECH</span></div>
    <button class="copy-btn" onclick="copyLink()">ðŸ”— COPY LINK</button>
</header>

<div id="video-grid">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
</div>

<div class="action-bar">
    <button class="icon-btn btn-call" onclick="startCall(false)" title="Voice Call">ðŸ“ž</button>
    <button class="icon-btn btn-video" onclick="startCall(true)" title="Video Call">ðŸ“¹</button>
    <button id="hangupBtn" class="icon-btn btn-hangup" onclick="location.reload()" title="End Call">ðŸš«</button>
</div>

<div id="chat-container"></div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
    <button class="send-btn" onclick="send()">âž”</button>
</div>

<script>
    const socket = io();
    const roomId = window.location.pathname.split('/').pop();
    const chatContainer = document.getElementById('chat-container');
    const msgInput = document.getElementById('msgInput');

    socket.emit('join-room', roomId);

    // --- 1. ENTER KEY LOGIC ---
    msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault(); // Prevents new line
            send();
        }
    });

    // --- 2. CHAT LOGIC ---
    function send() {
        const text = msgInput.value.trim();
        if (!text) return;
        
        const data = { roomId, msg: text, sender: socket.id };
        socket.emit('chat-msg', data);
        renderMessage(text, 'me');
        msgInput.value = '';
    }

    socket.on('render-msg', (data) => {
        if (data.sender !== socket.id) renderMessage(data.msg, 'them');
    });

    function renderMessage(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.textContent = text;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // --- 3. COPY LINK ---
    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        const btn = document.querySelector('.copy-btn');
        btn.textContent = "âœ… COPIED";
        setTimeout(() => btn.textContent = "ðŸ”— COPY LINK", 2000);
    }

    // --- 4. VOICE & VIDEO CALL LOGIC ---
    let localStream, peerConnection;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    async function startCall(videoEnabled) {
        // Show video grid only if video is enabled
        if(videoEnabled) document.getElementById('video-grid').classList.add('active');
        document.getElementById('hangupBtn').style.display = 'flex';

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoEnabled });
        document.getElementById('localVideo').srcObject = localStream;

        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = event => {
            document.getElementById('remoteVideo').srcObject = event.streams[0];
            // If the person calling has video, show the grid for the receiver too
            if(event.track.kind === 'video') document.getElementById('video-grid').classList.add('active');
        };

        peerConnection.onicecandidate = e => e.candidate && socket.emit('signal', { roomId, data: { candidate: e.candidate } });

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('signal', { roomId, data: { offer } });
    }

    socket.on('signal', async (data) => {
        if (!peerConnection) await startCall(true); // Auto-answer with video for simplicity
        
        if (data.offer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('signal', { roomId, data: { answer } });
        } else if (data.answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    });
</script>
</body>
</html>