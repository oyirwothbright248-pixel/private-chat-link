<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Private Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617;
            --panel: #0f172a;
            --accent: #0ea5e9;
            --neon: #38bdf8;
            --text: #f8fafc;
            --bubble-me: #0284c7;
            --bubble-them: #334155;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: var(--text);
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            overflow: hidden; /* Prevents bounce on mobile */
        }

        /* --- BRIGHT TECH HEADER --- */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px 20px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(56, 189, 248, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .logo-tech {
            font-weight: 800;
            letter-spacing: 1px;
            color: var(--neon);
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .copy-btn {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* --- VIDEO CALL GRID --- */
        #video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            background: #000;
            max-height: 0; /* Hidden until call starts */
            transition: max-height 0.5s ease-out;
            overflow: hidden;
        }

        #video-grid.active {
            max-height: 30vh;
            padding: 5px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            background: #1e293b;
        }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            animation: fadeIn 0.2s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .me { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
        .them { align-self: flex-start; background: var(--bubble-them); border-bottom-left-radius: 4px; }

        /* --- CALL CONTROLS --- */
        .call-tools {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            background: var(--panel);
            border-top: 1px solid #334155;
        }

        .icon-btn {
            background: #1e293b;
            border: 1px solid var(--accent);
            color: var(--accent);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        /* --- INPUT AREA --- */
        .input-area {
            padding: 15px 20px;
            background: var(--panel);
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            background: #020617;
            border: 1px solid #334155;
            padding: 12px 16px;
            border-radius: 25px;
            color: white;
            outline: none;
        }

        input:focus { border-color: var(--accent); }

        .send-btn {
            background: var(--accent);
            color: #020617;
            border: none;
            padding: 0 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            #video-grid.active { grid-template-columns: 1fr; max-height: 50vh; }
            .msg { max-width: 90%; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-tech">BRIGHT<span style="color:white">TECH</span></div>
    <div class="header-actions">
        <div id="room-id" style="font-size: 9px; color: var(--accent); text-align: right;"></div>
        <button class="copy-btn" onclick="copyLink()">ðŸ”— COPY LINK</button>
    </div>
</header>

<div id="video-grid">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
</div>

<div class="call-tools">
    <button class="icon-btn" onclick="startCall(false)">ðŸ“ž</button>
    <button class="icon-btn" onclick="startCall(true)">ðŸ“¹</button>
    <button class="icon-btn" style="border-color: #ef4444; color: #ef4444;" onclick="location.reload()">ðŸš«</button>
</div>

<div id="chat-container"></div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="Message..." autocomplete="off">
    <button class="send-btn" onclick="send()">Send</button>
</div>

<script>
    const socket = io();
    const roomId = window.location.pathname.split('/').pop();
    const chatContainer = document.getElementById('chat-container');
    const msgInput = document.getElementById('msgInput');

    document.getElementById('room-id').textContent = `ID: ${roomId}`;
    socket.emit('join-room', roomId);

    // --- CHAT LOGIC ---
    function send() {
        if (!msgInput.value.trim()) return;
        const data = { roomId, msg: msgInput.value, sender: socket.id };
        socket.emit('chat-msg', data);
        renderMessage(data.msg, 'me');
        msgInput.value = '';
    }

    msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") send(); });

    socket.on('render-msg', (data) => {
        if (data.sender !== socket.id) {
            renderMessage(data.msg, 'them');
        }
    });

    function renderMessage(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.textContent = text;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // --- COPY LINK LOGIC ---
    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        const btn = document.querySelector('.copy-btn');
        btn.textContent = "âœ… COPIED";
        setTimeout(() => btn.textContent = "ðŸ”— COPY LINK", 2000);
    }

    // --- VIDEO CALL LOGIC (WebRTC) ---
    let localStream;
    let peerConnection;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    async function startCall(videoEnabled) {
        document.getElementById('video-grid').classList.add('active');
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoEnabled });
        document.getElementById('localVideo').srcObject = localStream;

        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = event => {
            document.getElementById('remoteVideo').srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.emit('signal', { roomId, data: { candidate: event.candidate } });
            }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('signal', { roomId, data: { offer } });
    }

    socket.on('signal', async (data) => {
        if (!peerConnection) {
            // Auto-initiate connection for the receiver
            document.getElementById('video-grid').classList.add('active');
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            document.getElementById('localVideo').srcObject = localStream;
            peerConnection = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.ontrack = event => document.getElementById('remoteVideo').srcObject = event.streams[0];
            peerConnection.onicecandidate = e => e.candidate && socket.emit('signal', { roomId, data: { candidate: e.candidate } });
        }
        
        if (data.offer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('signal', { roomId, data: { answer } });
        } else if (data.answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    });
</script>
</body>
</html>