<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrightTech Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617; --panel: #0f172a; --accent: #0ea5e9; --neon: #38bdf8;
            --text: #f8fafc; --bubble-me: #0284c7; --bubble-them: #334155; --danger: #ef4444;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 20px; border: 1px solid var(--accent); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(14, 165, 233, 0.2); }
        .auth-card input { width: 100%; margin-bottom: 12px; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #020617; color: white; outline: none; transition: 0.3s; }
        .auth-card input:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        
        .auth-btn { width: 100%; padding: 14px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.2s; border: none; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .auth-link { color: var(--neon); font-size: 12px; cursor: pointer; text-decoration: underline; margin-top: 10px; display: inline-block; opacity: 0.7; }

        /* Spinner Style */
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .spinner { display: block; }
        .loading .btn-text { display: none; }

        /* Layout */
        #main-app { display: none; flex-direction: column; height: 100vh; width: 100%; }
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1e293b; flex-shrink: 0; z-index: 100; }
        
        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #000; max-height: 0; transition: 0.4s; overflow: hidden; flex-shrink: 0; }
        #video-grid.active { max-height: 25vh; padding: 10px; }
        video { width: 100%; border-radius: 8px; background: #1e293b; border: 1px solid var(--accent); }

        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: radial-gradient(circle at top right, #0f172a, #020617); }
        
        #contact-drawer { position: fixed; left: 0; top: 0; bottom: 0; width: 300px; background: var(--panel); transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1500; border-right: 1px solid var(--accent); display: flex; flex-direction: column; }
        #contact-drawer.open { transform: translateX(0); }
        .drawer-header { padding: 20px; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between; align-items: center; }
        #contacts-render { flex: 1; overflow-y: auto; padding: 10px; }
        
        .contact-item { padding: 12px; margin-bottom: 8px; background: #1e293b; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; position: relative; }
        .contact-avatar { width: 35px; height: 35px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .badge { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 800; display: none; }
        .badge.active { display: block; }

        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 2px; }
        .them { align-self: flex-start; background: var(--bubble-them); border-bottom-left-radius: 2px; }

        .input-box { background: var(--panel); padding: 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #1e293b; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        input[type="text"] { flex: 1; background: #020617; border: 1px solid #334155; padding: 12px 20px; border-radius: 25px; color: white; outline: none; }
        .btn-circle { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .btn-send { background: var(--accent); color: white; }
        .btn-voice { background: #1e293b; color: var(--neon); }
        .btn-voice.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .overlay-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1400; }
        #contact-drawer.open + .overlay-bg { display: block; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card" id="auth-card-main">
        <h2 style="color:var(--neon); margin-bottom: 5px;">BRIGHT TECH</h2>
        <p style="margin-bottom: 20px; opacity: 0.8;">Secure Communication Portal</p>
        
        <div id="login-fields">
            <input type="email" id="auth-email" placeholder="Email Address">
            <input type="password" id="auth-password" placeholder="Password">
            <button id="login-btn" class="auth-btn btn-primary" onclick="handleLogin()">
                <span class="btn-text">SIGN IN</span>
                <div class="spinner"></div>
            </button>
            <button id="signup-btn" class="auth-btn btn-outline" onclick="handleSignUp()">
                <span class="btn-text">CREATE ACCOUNT</span>
                <div class="spinner"></div>
            </button>
            <span class="auth-link" onclick="forgotPassword()">Forgot Password?</span>
        </div>

        <div id="token-fields" style="display:none">
            <p style="font-size: 13px; color: var(--neon);">Enter the 8-digit code sent to your email</p>
            <input type="text" id="auth-token" placeholder="Enter Token" maxlength="8" 
                   style="text-align: center; letter-spacing: 2px; font-weight: 800; font-size: 18px;">
            <button id="verify-btn" class="auth-btn btn-primary" onclick="verifyToken()">
                <span class="btn-text">VERIFY & ENTER</span>
                <div class="spinner"></div>
            </button>
            <div style="margin-top: 15px;">
                <span id="resend-link" class="auth-link" onclick="resendToken()">Resend Code</span>
                <span id="resend-timer" style="font-size: 11px; opacity: 0.5; display: none; color: var(--text);">Wait 60s to resend</span>
            </div>
            <span class="auth-link" onclick="location.reload()" style="display:block; margin-top:20px; opacity:0.5; text-decoration: none;">‚Üê Back to Login</span>
        </div>
    </div>
</div>

<div id="main-app">
    <div id="contact-drawer">
        <div class="drawer-header">
            <h3 style="margin:0">Contacts</h3>
            <button onclick="toggleDrawer()" style="background:none; border:none; color:white; font-size:20px;">‚úï</button>
        </div>
        <div id="contacts-render"></div>
        <div style="padding: 20px; border-top: 1px solid #1e293b;">
            <button onclick="clearHistory()" style="width:100%; color:var(--danger); background:rgba(239, 68, 68, 0.1); border:1px solid var(--danger); padding:10px; border-radius:8px; cursor:pointer;">üóëÔ∏è Wipe Chat History</button>
            <button onclick="logout()" style="width:100%; color:white; background:none; border:none; margin-top:10px; opacity:0.5; font-size:12px; cursor:pointer;">Logout Session</button>
        </div>
    </div>
    <div class="overlay-bg" onclick="toggleDrawer()"></div>

    <header>
        <button onclick="toggleDrawer()" style="background:none; border:none; font-size:24px; color:white; cursor:pointer;">‚ò∞</button>
        <div id="header-id" style="font-weight:600; font-size:14px; color:var(--neon);">Connecting...</div>
        <div style="display:flex; gap:12px;">
            <button onclick="initiateCall(false)" style="background:none; border:none; font-size:20px; cursor:pointer;">üìû</button>
            <button onclick="initiateCall(true)" style="background:none; border:none; font-size:20px; cursor:pointer;">üìπ</button>
            <button id="hangupBtn" onclick="endCall()" style="display:none; background:var(--danger); border:none; border-radius:50%; width:30px; height:30px; color:white; cursor:pointer;">‚úï</button>
        </div>
    </header>

    <div id="video-grid">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="chat-container"></div>

    <div class="input-box">
        <label class="btn-circle" style="background:#1e293b; color:var(--neon);">
            üìé<input type="file" id="file-input" style="display:none" onchange="handleFileUpload(this)">
        </label>
        <input type="text" id="msgInput" placeholder="Write a message...">
        <button id="voiceBtn" class="btn-circle btn-voice">üé§</button>
        <button class="btn-circle btn-send" onclick="send()">‚ûî</button>
    </div>
</div>

<script>
    const socket = io();
    const supabaseUrl = 'https://bcdnzmnmaxopmsimdetn.supabase.co';
    const supabaseKey = 'sb_publishable_C8ygL8VNGGJ2L2qqTP6g2g_hPYokDmy';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let myId = null;
    let targetId = window.location.pathname.split('/').pop();
    if(targetId === '' || targetId === 'room') targetId = null;

    let resendTimer = 0;
    let notifications = {};
    let localStream, peerConnection;

    function toggleLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        if (isLoading) btn.classList.add('loading');
        else btn.classList.remove('loading');
    }

    async function handleLogin() {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return alert("Please enter both email and password.");

        toggleLoading('login-btn', true);
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        
        if (error) {
            alert("Login Error: " + error.message);
            toggleLoading('login-btn', false);
        } else {
            const { error: otpError } = await supabaseClient.auth.signInWithOtp({ email });
            toggleLoading('login-btn', false);
            if (otpError) alert("Security Gate Error: " + otpError.message);
            else {
                showTokenView();
                startResendTimer();
            }
        }
    }

    async function handleSignUp() {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return alert("Please fill in all fields.");

        toggleLoading('signup-btn', true);
        const { error } = await supabaseClient.auth.signUp({ email, password });
        toggleLoading('signup-btn', false);
        
        if (error) alert("Signup Error: " + error.message);
        else {
            alert("Verification code sent! Check your email.");
            showTokenView();
            startResendTimer();
        }
    }

    async function verifyToken() {
        const email = document.getElementById('auth-email').value;
        const token = document.getElementById('auth-token').value.trim();
        if (!token) return alert("Please enter the token.");

        toggleLoading('verify-btn', true);
        const { error } = await supabaseClient.auth.verifyOtp({ email, token, type: 'signup' });

        if (error) {
            const { error: error2 } = await supabaseClient.auth.verifyOtp({ email, token, type: 'signin' });
            if(error2) {
                alert("Invalid Token: " + error2.message);
                toggleLoading('verify-btn', false);
            } else location.reload();
        } else location.reload();
    }

    async function resendToken() {
        if (resendTimer > 0) return; 
        const email = document.getElementById('auth-email').value;
        const { error } = await supabaseClient.auth.signInWithOtp({ email });
        if (error) alert("Action blocked: " + error.message);
        else {
            alert("A fresh token has been dispatched.");
            startResendTimer();
        }
    }

    function startResendTimer() {
        resendTimer = 60;
        const link = document.getElementById('resend-link');
        const timerDisplay = document.getElementById('resend-timer');
        link.style.display = 'none';
        timerDisplay.style.display = 'inline';
        const interval = setInterval(() => {
            resendTimer--;
            timerDisplay.innerText = `Wait ${resendTimer}s to resend`;
            if (resendTimer <= 0) {
                clearInterval(interval);
                link.style.display = 'inline';
                timerDisplay.style.display = 'none';
            }
        }, 1000);
    }

    function showTokenView() {
        document.getElementById('login-fields').style.display = 'none';
        document.getElementById('token-fields').style.display = 'block';
        setTimeout(() => document.getElementById('auth-token').focus(), 100); 
    }

    async function forgotPassword() {
        const email = document.getElementById('auth-email').value.trim();
        if (!email) return alert("Enter email first.");
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
        if (error) alert(error.message);
        else alert("Reset link sent!");
    }

    window.onload = async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            myId = session.user.id;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            socket.emit('join-session', { myId, targetId });
            document.getElementById('header-id').innerText = targetId ? `Chat: ${targetId}` : `ID: ${myId.substring(0,8)}...`;
        }
    };

    async function logout() { await supabaseClient.auth.signOut(); location.href = '/'; }
    
    socket.on('load-history', (history) => {
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';
        history.forEach(m => renderMessage(m, m.sender_id === myId ? 'me' : 'them'));
        updateContactList(history);
    });

    function renderMessage(msg, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        const content = msg.message || msg.msg;
        if (msg.type === 'voice') div.innerHTML = `<audio controls src="${msg.file_url}" style="width:200px"></audio>`;
        else if (msg.type === 'file') div.innerHTML = `üìÑ <a href="${msg.file_url}" target="_blank" style="color:white; font-weight:800;">View File</a>`;
        else div.textContent = content;
        document.getElementById('chat-container').appendChild(div);
        document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
    }

    function updateContactList(history) {
        const render = document.getElementById('contacts-render');
        const unique = new Set();
        history.forEach(m => { if(m.sender_id !== myId) unique.add(m.sender_id); });
        render.innerHTML = unique.size === 0 ? '<p style="text-align:center; opacity:0.5;">No contacts</p>' : '';
        unique.forEach(contact => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.id = `contact-${contact}`;
            div.onclick = () => location.href = `/room/${contact}`;
            const badgeClass = notifications[contact] ? 'badge active' : 'badge';
            div.innerHTML = `<div class="contact-avatar">${contact.substring(0,1).toUpperCase()}</div><div>${contact.substring(0,8)}...</div><div class="${badgeClass}">NEW</div>`;
            render.appendChild(div);
        });
    }

    async function uploadToSupabase(blob, name) {
        const fileName = `${Date.now()}_${name}`;
        const { data, error } = await supabaseClient.storage.from('chat-assets').upload(`uploads/${fileName}`, blob);
        if (error) return null;
        const { data: { publicUrl } } = supabaseClient.storage.from('chat-assets').getPublicUrl(`uploads/${fileName}`);
        return publicUrl;
    }

    async function send() {
        const input = document.getElementById('msgInput');
        if (!input.value.trim() || !targetId) return;
        const data = { sender: myId, target: targetId, msg: input.value, type: 'text' };
        socket.emit('chat-msg', data);
        renderMessage(data, 'me');
        input.value = '';
    }

    socket.on('render-msg', (data) => { 
        if (data.sender !== myId) {
            if (data.sender === targetId) renderMessage(data, 'them');
            else {
                notifications[data.sender] = true;
                const badge = document.querySelector(`#contact-${data.sender} .badge`);
                if(badge) badge.classList.add('active');
            }
        }
    });

    let mediaRecorder, audioChunks = [];
    const voiceBtn = document.getElementById('voiceBtn');
    voiceBtn.onmousedown = startVoice; voiceBtn.onmouseup = stopVoice;

    async function startVoice() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            voiceBtn.classList.add('recording');
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        } catch(e) { console.error("Mic access denied"); }
    }

    async function stopVoice() {
        if (!mediaRecorder || mediaRecorder.state === "inactive") return;
        mediaRecorder.stop();
        voiceBtn.classList.remove('recording');
        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const url = await uploadToSupabase(blob, 'voice.webm');
            if(url) {
                const data = { sender: myId, target: targetId, type: 'voice', msg: 'Voice Note', file_url: url };
                socket.emit('chat-msg', data);
                renderMessage(data, 'me');
            }
        };
    }

    async function handleFileUpload(input) {
        if(input.files[0]) {
            const url = await uploadToSupabase(input.files[0], input.files[0].name);
            if(url) {
                const data = { sender: myId, target: targetId, type: 'file', msg: `File: ${input.files[0].name}`, file_url: url };
                socket.emit('chat-msg', data);
                renderMessage(data, 'me');
            }
        }
    }

    function toggleDrawer() { document.getElementById('contact-drawer').classList.toggle('open'); }
    function clearHistory() { if(confirm("Wipe chat?")) socket.emit('clear-history', { myId, targetId }); }

    async function initiateCall(video) {
        if(!targetId) return alert("Select a contact");
        socket.emit('call-request', { sender: myId, target: targetId, video });
        startRTC(video);
    }

    socket.on('incoming-call', (data) => {
        if (confirm(`Incoming call from ${data.sender}. Answer?`)) startRTC(data.video);
    });

    async function startRTC(videoEnabled) {
        if(videoEnabled) document.getElementById('video-grid').classList.add('active');
        document.getElementById('hangupBtn').style.display = 'block';
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoEnabled });
        document.getElementById('localVideo').srcObject = localStream;
        peerConnection = new RTCPeerConnection();
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = e => {
            document.getElementById('remoteVideo').srcObject = e.streams[0];
            document.getElementById('video-grid').classList.add('active');
        };
        peerConnection.onicecandidate = e => {
            if(e.candidate) socket.emit('signal', { sender: myId, target: targetId, data: { candidate: e.candidate } });
        };
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('signal', { sender: myId, target: targetId, data: { offer } });
    }

    socket.on('signal', async (data) => {
        if (!peerConnection) return;
        if (data.offer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('signal', { sender: myId, target: targetId, data: { answer } });
        } else if (data.answer) await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        else if (data.candidate) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    });

    function endCall() { location.reload(); }
</script>
</body>
</html>